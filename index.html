<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ù…Ø­Ø±Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³|Lesson review editor</title>
    <style>
      :root {
        --bg: #0f172a;
        --surface: #111827;
        --muted: #1f2937;
        --text: #e5e7eb;
        --subtext: #cbd5e1;
        --primary: #22c55e;
        --danger: #ef4444;
        --warning: #f59e0b;
        --radius: 16px;
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        scroll-behavior: smooth;
      }

      body {
        background: linear-gradient(180deg, var(--bg), #0b1220 30%, #0a0f1a);
        color: var(--text);
        font-family: "Segoe UI", Tahoma, system-ui, -apple-system,
          "Noto Naskh Arabic UI", Arial, sans-serif;
        line-height: 1.6;
        overflow-x: hidden;
      }
      :where(button, input, select, textarea) {
        font: inherit;
      }
      a {
        color: var(--primary);
        text-decoration: none;
      }

      /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(17, 24, 39, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #243041;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header-inner {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .badge {
        background: var(--muted);
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        color: var(--subtext);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .badge.warning {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
      }

      .badge.success {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
      }

      .container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 20px;
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
      .sidebar {
        background: linear-gradient(180deg, #0b1220, #0a0f1a);
        border: 1px solid #233045;
        border-radius: var(--radius);
        padding: 16px;
        height: calc(100vh - 80px);
        position: sticky;
        top: 80px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .sidebar-section {
        background: rgba(15, 23, 42, 0.5);
        border-radius: 12px;
        padding: 12px;
      }

      .sidebar-section-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--subtext);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* Ø§Ù„ÙƒØ±ÙˆØª */
      .card {
        background: linear-gradient(180deg, #0d1523, #0b1220);
        border: 1px solid #233045;
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .row.wrap {
        flex-wrap: wrap;
      }

      .col {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-size: 13px;
        color: var(--subtext);
        font-weight: 500;
      }

      input[type="text"],
      input[type="number"],
      input[type="color"],
      select,
      textarea {
        background: #0b1220;
        border: 1px solid #243041;
        color: var(--text);
        padding: 10px 12px;
        border-radius: 10px;
        width: 100%;
        outline: none;
        transition: var(--transition);
        font-family: inherit;
      }

      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
      button {
        appearance: none;
        border: 1px solid #243041;
        cursor: pointer;
        color: #fff;
        background: linear-gradient(
          180deg,
          var(--primary),
          color-mix(in oklab, var(--primary) 70%, black)
        );
        padding: 10px 16px;
        border-radius: 12px;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-family: inherit;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      button:active {
        transform: translateY(0);
      }

      button.secondary {
        background: linear-gradient(180deg, #1e293b, #0f172a);
      }

      button.danger {
        background: linear-gradient(180deg, var(--danger), #7f1d1d);
      }

      button.ghost {
        background: transparent;
        border-color: #334155;
      }

      button.warning {
        background: linear-gradient(180deg, var(--warning), #92400e);
      }

      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .section {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .pill {
        background: #0b1220;
        border: 1px solid #243041;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .list-item {
        background: #0b1220;
        border: 1px dashed #334155;
        padding: 16px;
        border-radius: 12px;
        transition: var(--transition);
      }

      .list-item:hover {
        border-color: var(--primary);
      }

      .hr {
        height: 1px;
        background: #243041;
        margin: 12px 0;
      }

      .hint {
        color: #9ca3af;
        font-size: 12px;
        line-height: 1.5;
      }

      .title {
        font-size: 22px;
        font-weight: 800;
        background: linear-gradient(90deg, #22c55e, #3b82f6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }

      .subtitle {
        color: #a1a1aa;
        font-size: 14px;
      }

      /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
      .tabs {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #243041;
        padding-bottom: 12px;
      }

      .tab {
        background: #0b1220;
        border: 1px solid #2a3b52;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        color: #cbd5e1;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tab:hover {
        background: #1e293b;
      }

      .tab.active {
        background: var(--primary);
        border-color: transparent;
        color: #0a0f1a;
      }

      .tab:not(:last-child)::after {
        content: "â†";
        opacity: 0.6;
        margin-inline: 6px;
      }

      .table {
        width: 100%;
        border-collapse: collapse;
        margin: 12px 0;
      }

      .table th,
      .table td {
        border: 1px solid #2a3b52;
        padding: 10px;
        text-align: right;
        vertical-align: top;
      }

      .table th {
        background: rgba(15, 23, 42, 0.5);
        font-weight: 600;
      }

      .dz {
        border: 1px dashed #334155;
        border-radius: 10px;
        padding: 12px;
        text-align: center;
        font-size: 12px;
        color: #a1a1aa;
        cursor: pointer;
        transition: var(--transition);
      }

      .dz:hover {
        border-color: var(--primary);
        background: rgba(34, 197, 94, 0.05);
      }

      .dz:focus {
        outline: 2px solid var(--primary);
      }

      /* ÙØ§ØµÙ„ Ø£ÙˆØ¶Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
      .hr.wide {
        height: 0;
        border-top: 2px dashed #334155;
        background: transparent;
        margin: 20px 0;
      }

      /* Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ */
      .section-title {
        font-size: 16px;
        font-weight: 700;
        color: #cbd5e1;
        margin: 8px 0 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .section-title::before {
        content: "";
        display: block;
        width: 4px;
        height: 16px;
        background: var(--primary);
        border-radius: 2px;
      }

      /* Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„ØµÙˆØ± */
      .img-preview,
      .ex-img-preview,
      .logo-preview {
        max-height: 100px;
        border: 1px solid #243041;
        border-radius: 8px;
        object-fit: contain;
        background: #0b1220;
        padding: 4px;
        transition: var(--transition);
      }

      .img-preview:hover,
      .ex-img-preview:hover,
      .logo-preview:hover {
        transform: scale(1.02);
      }

      /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
      .icon {
        width: 16px;
        height: 16px;
        display: inline-block;
      }

      /* Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
      .progress-container {
        margin: 16px 0;
      }

      .progress-bar {
        height: 6px;
        background: #1e293b;
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary);
        border-radius: 3px;
        transition: width 0.5s ease;
      }

      .progress-text {
        font-size: 12px;
        color: var(--subtext);
        display: flex;
        justify-content: space-between;
      }

      /* Ø§Ù„ØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
      @media (max-width: 960px) {
        .container {
          grid-template-columns: 1fr;
          padding: 16px;
        }

        .sidebar {
          position: static;
          height: auto;
          max-height: 400px;
        }

        .grid-2,
        .grid-3 {
          grid-template-columns: 1fr;
        }

        .header-inner {
          flex-wrap: wrap;
        }

        .tabs {
          overflow-x: auto;
          padding-bottom: 8px;
        }
      }

      @media (max-width: 640px) {
        .toolbar {
          flex-direction: column;
          align-items: stretch;
        }

        .toolbar button {
          width: 100%;
        }
      }

      /* ØªØ£Ø«ÙŠØ±Ø§Øª Ù„Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ø´Ø·Ø© */
      .active-item {
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }

      /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø¸Ù‡Ø± Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ÙÙŠØ© */
      [hidden] {
        display: none !important;
      }

      /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…Ø±ÙŠØ± */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #0f172a;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #475569;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <div class="title">Ù…Ø­Ø±Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</div>
        <div class="badge">
          <span class="icon">ğŸ“‹</span> v3.0 â€“ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø­Ø³Ù†Ø© ÙˆØªÙ†Ø¸ÙŠÙ… Ø£ÙØ¶Ù„
        </div>
        <div class="badge warning" id="status">
          <span class="icon">âš ï¸</span> ØºÙŠØ± Ù…Ø­ÙÙˆØ¸
        </div>
        <div style="margin-inline-start: auto" class="toolbar">
          <button id="btnPreview" class="secondary">
            <span class="icon">ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
          </button>
          <button id="btnExportHTML">
            <span class="icon">ğŸ“¥</span> ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (HTML)
          </button>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
      <aside class="sidebar" aria-label="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹">
        <div class="sidebar-section">
          <div class="sidebar-section-title">
            <span class="icon">ğŸ”„</span> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          </div>
          <div class="col">
            <div class="row wrap">
              <button id="btnNew" class="ghost">
                <span class="icon">â•</span> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
              </button>
              <button id="btnSave">
                <span class="icon">ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
              </button>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">
            <span class="icon">ğŸ“‚</span> Ù…Ø´Ø§Ø±ÙŠØ¹ÙŠ
          </div>
          <div class="col">
            <label for="selProjects">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹</label>
            <select id="selProjects"></select>
            <div class="toolbar">
              <button id="btnLoad" class="secondary">
                <span class="icon">ğŸ“‚</span> ØªØ­Ù…ÙŠÙ„
              </button>
              <button id="btnDuplicate" class="secondary">
                <span class="icon">ğŸ“‹</span> Ø§Ø³ØªÙ†Ø³Ø§Ø®
              </button>
              <button id="btnDelete" class="danger">
                <span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù
              </button>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">
            <span class="icon">ğŸ“¤</span> Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ±
          </div>
          <div class="col">
            <button id="btnExportJSON" class="secondary">
              <span class="icon">ğŸ’¾</span> ØªØµØ¯ÙŠØ± JSON
            </button>
            <input
              type="file"
              id="importFile"
              accept="application/json"
              style="display: none"
            />
            <button id="btnImportJSON" class="secondary">
              <span class="icon">ğŸ“¤</span> Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-section-title">
            <span class="icon">ğŸ“Š</span> ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
          </div>
          <div class="progress-container">
            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 30%"
              ></div>
            </div>
            <div class="progress-text">
              <span>Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span>
              <span id="progressPercent">30%</span>
            </div>
          </div>
        </div>

        <div class="hint">
          <span class="icon">ğŸ’¡</span> Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ (localStorage). Ø§Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø®Ø©
          JSON Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.
        </div>
      </aside>

      <!-- Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± -->
      <main class="card" aria-label="Ù…Ø­Ø±Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
        <div class="tabs" role="tablist" aria-label="Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯">
          <div
            class="tab active"
            data-tab="meta"
            role="tab"
            aria-selected="true"
          >
            <span class="icon">ğŸ“</span> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
          </div>
          <div class="tab" data-tab="feedback" role="tab">
            <span class="icon">ğŸ”„</span> ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©
          </div>
          <div class="tab" data-tab="exercises" role="tab">
            <span class="icon">ğŸ“š</span> ØªÙ…Ø§Ø±ÙŠÙ† Ù…Ø­Ù„ÙˆÙ„Ø©
          </div>
          <div class="tab" data-tab="quiz" role="tab">
            <span class="icon">â“</span> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
          </div>
          <div class="tab" data-tab="footer" role="tab">
            <span class="icon">ğŸ“„</span> Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ù„Ø´Ø¹Ø§Ø±
          </div>
          <div class="tab" data-tab="design" role="tab">
            <span class="icon">ğŸ¨</span> Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØ§Ù„ØªÙˆÙ„ÙŠØ¯
          </div>
        </div>

        <!-- META -->
        <section id="tab-meta" class="section" role="tabpanel">
          <div class="grid-2">
            <div class="col">
              <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
              <input
                id="title"
                type="text"
                placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙˆØ±Ø© Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙÙƒÙŠØ±"
              />
            </div>
            <div class="col">
              <label>Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„ØµÙ</label>
              <input
                id="subject"
                type="text"
                placeholder="Ù…Ø«Ø§Ù„: Ù…Ù‡Ø§Ø±Ø§Øª Ø­ÙŠØ§ØªÙŠØ© â€“ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«"
              />
            </div>
          </div>

          <div class="grid-3">
            <div class="col">
              <label>Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
              <input id="duration" type="number" min="5" step="5" value="45" />
            </div>
            <div class="col">
              <label>Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„Ù… (ÙƒÙ„ Ù‡Ø¯Ù Ø¨Ø³Ø·Ø±)</label>
              <textarea
                id="objectives"
                placeholder="ÙŠØ¹Ø±Ù‘Ù Ù…ÙÙ‡ÙˆÙ… ...&#10;ÙŠÙ…ÙŠØ² Ø¨ÙŠÙ† ...&#10;ÙŠØ·Ø¨Ù‘Ù‚ ..."
              ></textarea>
            </div>
            <div class="col">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ù…Ø¹Ù„Ù… (Ù„Ù† ØªØ¸Ù‡Ø± Ù„Ù„Ø·Ø§Ù„Ø¨)</label>
              <textarea
                id="teacherNotes"
                placeholder="Ø±ÙˆØ§Ø¨Ø· - ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø£Ù†Ø´Ø·Ø© - ØªÙ‚ÙŠÙŠÙ…"
              ></textarea>
            </div>
          </div>
        </section>

        <div class="hr wide"></div>

        <!-- FEEDBACK -->
        <section id="tab-feedback" class="section" role="tabpanel" hidden>
          <div class="col">
            <div class="section-title">Ù†ØµÙˆØµ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</div>
            <label>Ù†Øµ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© (ÙÙ‚Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©)</label>
            <textarea
              id="feedbackText"
              placeholder="Ø§ÙƒØªØ¨ Ù†ØµÙˆØµÙ‹Ø§ Ù‚ØµÙŠØ±Ø© ØªØ°ÙƒÙ‘Ø± Ø¨Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©..."
            ></textarea>
          </div>

          <div class="col">
            <div class="section-title">Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµÙˆÙ‘ÙØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <label class="row"
              >ØµÙˆØ± Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© <span class="pill">Ø§Ø®ØªÙŠØ§Ø±ÙŠ</span></label
            >
            <div class="list" id="feedbackImages"></div>
            <div class="toolbar">
              <button id="btnAddFeedbackImg" class="secondary">
                <span class="icon">ğŸ–¼ï¸</span> Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©
              </button>
            </div>
            <div class="hint">
              ÙŠÙ…ÙƒÙ†: Ø±Ø§Ø¨Ø·ØŒ Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø£Ùˆ Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©.
            </div>
          </div>
          <div class="col">
            <div class="section-title">Ø´Ø±Ø­ ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
            <div class="grid-3">
              <div class="col">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                <input
                  id="feedbackVideoUrl"
                  type="text"
                  placeholder="https://youtu.be/xxxx Ø£Ùˆ https://example.com/clip.mp4"
                />
              </div>
              <div class="col">
                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø±Ø¶</label>
                <select id="feedbackVideoMode">
                  <option value="link">Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø·</option>
                  <option value="embed">Ø¹Ø±Ø¶ Ù…Ø¨Ø§Ø´Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©</option>
                </select>
              </div>
              <div class="col">
                <label>ØªÙ„Ù…ÙŠØ­</label>
                <div class="hint">
                  Ù„Ù† ØªØ¸Ù‡Ø± Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø¥Ø°Ø§ ØªØ±ÙƒØª Ø§Ù„Ø±Ø§Ø¨Ø· ÙØ§Ø±ØºÙ‹Ø§.
                </div>
              </div>
            </div>
          </div>
        </section>

        <div class="hr wide"></div>

        <!-- EXERCISES -->
        <section id="tab-exercises" class="section" role="tabpanel" hidden>
          <div class="section-title">Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠÙ† Ø¬Ø¯ÙŠØ¯</div>
          <div class="toolbar">
            <button id="btnAddExercise" class="secondary">
              <span class="icon">â•</span> Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠÙ†
            </button>
          </div>

          <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§</div>
          <div id="exercisesList" class="list"></div>
        </section>

        <div class="hr wide"></div>

        <!-- QUIZ -->
        <section id="tab-quiz" class="section" role="tabpanel" hidden>
          <div class="section-title">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯</div>
          <div class="toolbar">
            <button id="btnAddQuestion" class="secondary">
              <span class="icon">â•</span> Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„
            </button>
          </div>

          <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
          <div id="quizList" class="list"></div>

          <div class="hint">
            Ø§Ø¨Ø¯Ø£ Ø¨Ø³Ø¤Ø§Ù„ Ø¨Ø®ÙŠØ§Ø±ÙŠÙ† ÙˆÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯ØªÙ‡Ø§ Ø­ØªÙ‰ 6. Ù„ÙƒÙ„ Ø®ÙŠØ§Ø± Ù†Øµ ÙˆØµÙˆØ±Ø©.
          </div>
        </section>

        <div class="hr wide"></div>

        <!-- FOOTER + LOGO -->
        <section id="tab-footer" class="section" role="tabpanel" hidden>
          <div class="col">
            <div class="section-title">Ù†Øµ ØªØ°ÙŠÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</div>
            <label>ØªØ°ÙŠÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <textarea
              id="footerText"
              placeholder="Ø­Ù‚ÙˆÙ‚ØŒ Ù…ØµØ§Ø¯Ø±ØŒ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø´ÙƒØ± Ø®Ø§Øµ..."
            ></textarea>
          </div>

          <div class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± (Ø±ÙØ¹/Ù„ØµÙ‚/Ù…Ø¹Ø§ÙŠÙ†Ø©)</div>
          <div class="list-item" id="brandLogoWrap">
            <div class="title" style="font-size: 16px">
              <span class="icon">ğŸ¢</span> Ø§Ù„Ø´Ø¹Ø§Ø± (ÙŠØ¸Ù‡Ø± ÙŠØ³Ø§Ø± Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙÙŠ ØµÙØ­Ø©
              Ø§Ù„Ø·Ø§Ù„Ø¨)
            </div>

            <div class="grid-3">
              <div class="col">
                <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input
                  type="text"
                  class="logo-url"
                  placeholder="https://.../logo.png"
                />
              </div>
              <div class="col">
                <label>Ø±ÙØ¹ Ø´Ø¹Ø§Ø±</label>
                <input type="file" accept="image/*" class="logo-file" />
                <div class="dz logo-paste" tabindex="0" style="margin-top: 6px">
                  Ù„ØµÙ‚/Ø¥ÙÙ„Ø§Øª ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§
                </div>
              </div>
              <div class="col">
                <label>Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
                <img class="logo-preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø´Ø¹Ø§Ø±" />
              </div>
            </div>

            <div class="col" style="max-width: 400px">
              <label>Ù†Øµ Ø¨Ø¯ÙŠÙ„ (alt)</label>
              <input
                type="text"
                class="logo-alt"
                placeholder="ÙˆØµÙ Ø§Ù„Ø´Ø¹Ø§Ø± Ù„Ø°ÙˆÙŠ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª"
              />
            </div>

            <div class="hint">
              Ø¹Ù†Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø³ÙŠØªÙ… ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø®Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù„Ù (Base64).
            </div>
          </div>
          <div class="col" style="max-width: 420px">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø§Ù„Ù…Ø¹Ù„Ù…Ø© (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²)</label>
            <input id="teacherName" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø£. ÙØ§Ø·Ù…Ø© " />
          </div>
        </section>

        <div class="hr wide"></div>

        <!-- DESIGN / PUBLISH -->
        <section id="tab-design" class="section" role="tabpanel" hidden>
          <div class="grid-3">
            <div class="col">
              <label>Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
              <input id="primaryColor" type="color" value="#22c55e" />
            </div>
            <div class="col">
              <label>Ø®Ø· Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</label>
              <select id="fontFamily">
                <option value="Tahoma, Arial, sans-serif">Tahoma</option>
                <option value="Segoe UI, Tahoma, Arial, sans-serif" selected>
                  Segoe UI
                </option>
                <option
                  value="system-ui, -apple-system, Segoe UI, Arial, sans-serif"
                >
                  System UI
                </option>
                <option value="Cairo, Tahoma, Arial, sans-serif">
                  Cairo (Ø¥Ù† ÙƒØ§Ù† Ù…Ø«Ø¨ØªÙ‹Ø§)
                </option>
              </select>
            </div>
            <div class="col">
              <label>Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©</label>
              <select id="rtl">
                <option value="true" selected>ÙŠÙ…ÙŠÙ† â† ÙŠØ³Ø§Ø± (RTL)</option>
                <option value="false">ÙŠØ³Ø§Ø± â† ÙŠÙ…ÙŠÙ† (LTR)</option>
              </select>
            </div>
          </div>

          <div class="list-item">
            <div class="title" style="font-size: 16px">
              <span class="icon">ğŸ”¤</span> ØªØ¶Ù…ÙŠÙ† Ø®Ø· Ù…Ø®ØµØµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            </div>

            <div class="grid-3">
              <div class="col">
                <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø·</label>
                <input id="fontName" type="text" placeholder="CustomFont" />
              </div>
              <div class="col">
                <label>Ù…Ù„Ù Ø§Ù„Ø®Ø·</label>
                <input
                  id="fontFile"
                  type="file"
                  accept=".woff2,.woff,.ttf,.otf"
                />
              </div>
              <div class="col">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                <div id="fontStatus" class="pill">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø· Ù…Ø¶Ù…Ù‘Ù†</div>
              </div>
            </div>

            <div class="hint">
              Ø³ÙŠÙØ­Ù‚Ù† Ø§Ù„Ø®Ø· Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ø¨Ø± <code>@font-face</code>.
            </div>
          </div>

          <div class="hr"></div>

          <div class="toolbar">
            <button id="btnPreview2" class="secondary">
              <span class="icon">ğŸ‘ï¸</span> Ù…Ø¹Ø§ÙŠÙ†Ø© ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
            </button>
            <button id="btnExportHTML2">
              <span class="icon">ğŸ“¥</span> ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (HTML)
            </button>
          </div>

          <div class="hint">ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©.</div>
        </section>
      </main>
    </div>

    <!-- Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ -->
    <template id="tpl-feedback-img">
      <div class="list-item row wrap" tabindex="0">
        <div class="col" style="flex: 1 1 260px">
          <label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (URL)</label>
          <input
            type="text"
            placeholder="https://.../image.png"
            class="img-url"
          />
          <label>Ù†Øµ Ø¨Ø¯ÙŠÙ„ (alt)</label>
          <input type="text" placeholder="ÙˆØµÙ Ù…ÙˆØ¬Ø² Ù„Ù„ØµÙˆØ±Ø©" class="img-alt" />
        </div>
        <div class="col" style="min-width: 220px">
          <label>Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
          <img class="img-preview" alt="" />
          <div class="dz img-paste" tabindex="0">Ù„ØµÙ‚/Ø¥ÙÙ„Ø§Øª ØµÙˆØ±Ø© Ù‡Ù†Ø§</div>
          <input type="file" accept="image/*" class="img-file" />
        </div>
        <div class="col" style="justify-content: flex-end">
          <label>&nbsp;</label>
          <button class="danger btn-remove">
            <span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù
          </button>
        </div>
      </div>
    </template>

    <template id="tpl-exercise">
      <div class="list-item">
        <div class="grid-2">
          <div class="col">
            <label>Ù†Øµ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</label>
            <textarea
              class="ex-prompt"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨..."
            ></textarea>
          </div>
          <div class="col">
            <label>Ø§Ù„Ø­Ù„/Ø§Ù„Ø®Ø·ÙˆØ§Øª</label>
            <textarea
              class="ex-solution"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© Ø£Ùˆ Ø§Ù„Ø®Ø·ÙˆØ§Øª"
            ></textarea>
          </div>
        </div>

        <div class="grid-3" style="margin-top: 8px">
          <div class="col">
            <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input
              type="text"
              class="ex-img-url"
              placeholder="https://.../img.png"
            />
          </div>
          <div class="col">
            <label>Ø±ÙØ¹/Ù„ØµÙ‚ ØµÙˆØ±Ø©</label>
            <input type="file" accept="image/*" class="ex-img-file" />
            <div class="dz ex-img-paste" tabindex="0" style="margin-top: 6px">
              Ù„ØµÙ‚/Ø¥ÙÙ„Ø§Øª ØµÙˆØ±Ø©
            </div>
          </div>
          <div class="col">
            <label>Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
            <img class="ex-img-preview" alt="" />
          </div>
        </div>

        <div class="row wrap" style="margin-top: 8px">
          <button class="secondary btn-move-up">
            <span class="icon">â¬†ï¸</span> Ù„Ù„Ø£Ø¹Ù„Ù‰
          </button>
          <button class="secondary btn-move-down">
            <span class="icon">â¬‡ï¸</span> Ù„Ù„Ø£Ø³ÙÙ„
          </button>
          <div style="flex: 1"></div>
          <button class="danger btn-remove">
            <span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù
          </button>
        </div>
      </div>
    </template>

    <template id="tpl-question">
      <div class="list-item">
        <div class="col">
          <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
          <textarea class="q-text" placeholder="Ø§ÙƒØªØ¨ ØµÙŠØºØ© Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
        </div>

        <div class="grid-2">
          <div class="col">
            <label>ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input type="text" class="q-img-url" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©" />
            <div class="dz q-img-paste" tabindex="0">Ù„ØµÙ‚/Ø¥ÙÙ„Ø§Øª ØµÙˆØ±Ø© Ù‡Ù†Ø§</div>
            <input type="file" accept="image/*" class="q-img-file" />
          </div>
          <div class="col">
            <label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
            <select class="q-correct"></select>
          </div>
        </div>

        <div class="toolbar">
          <button class="secondary btn-add-option">
            <span class="icon">â•</span> Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±
          </button>
        </div>

        <table class="table" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„">
          <thead>
            <tr>
              <th style="width: 60px">#</th>
              <th>Ø§Ù„Ù†Øµ</th>
              <th style="width: 260px">Ø§Ù„ØµÙˆØ±Ø©</th>
              <th style="width: 120px">Ø¥Ø²Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody class="q-options-body"></tbody>
        </table>

        <div class="row wrap" style="margin-top: 8px">
          <button class="secondary btn-move-up">
            <span class="icon">â¬†ï¸</span> Ù„Ù„Ø£Ø¹Ù„Ù‰
          </button>
          <button class="secondary btn-move-down">
            <span class="icon">â¬‡ï¸</span> Ù„Ù„Ø£Ø³ÙÙ„
          </button>
          <div style="flex: 1"></div>
          <button class="danger btn-remove">
            <span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„
          </button>
        </div>
      </div>
    </template>

    <template id="tpl-option-row">
      <tr>
        <td class="opt-index">â€”</td>
        <td>
          <input class="opt-text" type="text" placeholder="Ù†Øµ Ø§Ù„Ø®ÙŠØ§Ø±" />
          <!-- Ø¬Ø¯ÙŠØ¯: ØªØ¹Ù„ÙŠÙ‚ Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ­ÙŠØ­ -->
          <input
            class="opt-comment"
            type="text"
            placeholder="ØªØ¹Ù„ÙŠÙ‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) â€” ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ­ÙŠØ­"
            style="margin-top: 6px"
          />
        </td>
        <td>
          <input
            type="text"
            class="opt-img-url"
            placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"
          />
          <div class="dz opt-img-paste" tabindex="0">Ù„ØµÙ‚/Ø¥ÙÙ„Ø§Øª ØµÙˆØ±Ø©</div>
          <input type="file" accept="image/*" class="opt-img-file" />
        </td>
        <td>
          <button class="danger btn-remove-option">
            <span class="icon">ğŸ—‘ï¸</span> Ø­Ø°Ù
          </button>
        </td>
      </tr>
    </template>

    <footer dir="rtl" style="text-align: center; font-family: inherit">
      <p>
        Ø¨Ø±Ù…Ø¬Ø© :
        <a href="https://t.me/ITG_KSA" target="_blank" rel="noopener">
          Ù…Ù„ØªÙ‚Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ | Interactive Teaching Group (ITG)
        </a>
      </p>
      <p>Ù…Ø­Ø±Ø± Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù‘Ù… | 2025</p>
    </footer>

    <script>
      // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====
      const emptyState = () => ({
        id: null,
        meta: {
          title: "",
          subject: "",
          duration: 45,
          objectives: "",
          teacherNotes: "",
        },
        // ÙƒØ§Ù†: feedback: { text: "", images: [] },
        feedback: { text: "", images: [], video: { url: "", mode: "link" } },
        exercises: [], // [{prompt,solution,image:{url,data}}]
        quiz: [], // [{text,image:{url,data},options:[{text,image:{url,data}}],correct}]
        design: {
          primary: "#22c55e",
          font: "Segoe UI, Tahoma, Arial, sans-serif",
          rtl: true,
          fontData: "",
          fontName: "CustomFont",
        },
        footer: { text: "", teacher: "" },
        branding: { logo: { url: "", data: "", alt: "" } }, // Ø´Ø¹Ø§Ø± Ø§Ù„ØµÙØ­Ø©
      });

      let state = emptyState();

      // ===== Ø£Ø¯ÙˆØ§Øª =====
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      const status = (txt, isSuccess = false) => {
        const statusEl = $("#status");
        statusEl.textContent = txt;

        if (isSuccess) {
          statusEl.classList.remove("warning");
          statusEl.classList.add("success");
          statusEl.innerHTML = '<span class="icon">âœ…</span> ' + txt;
        } else {
          statusEl.classList.remove("success");
          statusEl.classList.add("warning");
          statusEl.innerHTML = '<span class="icon">âš ï¸</span> ' + txt;
        }
      };

      const uid = () => "p" + Date.now().toString(36);
      const escapeHtml = (str = "") =>
        str.replace(
          /[&<>\"]/g,
          (ch) =>
            ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;" }[ch] ||
            ch)
        );

      // ØªØ­ÙˆÙŠÙ„ Ø£ÙŠ Ø±Ø§Ø¨Ø· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ <a> Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù†Ù‚Ø±
      const linkify = (html) =>
        html.replace(/((?:https?:\/\/|www\.)[^\s<]+)/g, (m) => {
          const url = m.startsWith("http") ? m : "http://" + m;
          return (
            '<a href="' + url + '" target="_blank" rel="noopener">' + m + "</a>"
          );
        });

      const paragraphs = (text = "") =>
        text
          .split(/\n+/)
          .map((x) => x.trim())
          .filter(Boolean)
          .map((p) => `<p>${linkify(escapeHtml(p))}</p>`)
          .join("\n");

      const isDataUrl = (u = "") => /^data:/i.test(u);

      // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨ØµÙŠØºØ© Ø¹Ø±Ø¨ÙŠØ© Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©
      const toArabicDigits = (x) =>
        String(x).replace(/\d/g, (d) => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);

      // ===== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ =====
      function saveToLocal() {
        const list = JSON.parse(
          localStorage.getItem("lesson_projects") || "[]"
        );
        const idx = list.findIndex((p) => p.id === state.id);
        const snapshot = JSON.parse(JSON.stringify(state));

        if (state.id == null) {
          snapshot.id = uid();
          state.id = snapshot.id;
        }

        if (idx > -1) list[idx] = snapshot;
        else list.push(snapshot);

        localStorage.setItem("lesson_projects", JSON.stringify(list));
        populateProjects();
        updateProgress();
        status("ØªÙ… Ø§Ù„Ø­ÙØ¸", true);
      }

      function populateProjects() {
        const sel = $("#selProjects");
        const list = JSON.parse(
          localStorage.getItem("lesson_projects") || "[]"
        );
        sel.innerHTML = "";

        list.forEach((p) => {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.meta?.title || `Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù„Ø§ Ø¹Ù†ÙˆØ§Ù† (${p.id})`;
          sel.appendChild(opt);
        });

        if (state.id) {
          sel.value = state.id;
        }
      }

      function loadFromLocal(id) {
        const list = JSON.parse(
          localStorage.getItem("lesson_projects") || "[]"
        );
        const p = list.find((x) => x.id === id);

        if (!p) {
          alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹");
          return;
        }

        migrateProject(p);
        state = p;
        renderAll();
        status("ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„", true);

        p.feedback = Object.assign(
          { text: "", images: [], video: { url: "", mode: "link" } },
          p.feedback || {}
        );
        if (!p.feedback.video) p.feedback.video = { url: "", mode: "link" };

        p.footer = Object.assign({ text: "", teacher: "" }, p.footer || {});
      }

      function deleteFromLocal(id) {
        let list = JSON.parse(localStorage.getItem("lesson_projects") || "[]");
        list = list.filter((p) => p.id !== id);
        localStorage.setItem("lesson_projects", JSON.stringify(list));
        populateProjects();
        status("ØªÙ… Ø§Ù„Ø­Ø°Ù", true);
      }

      function duplicateProject() {
        const copy = JSON.parse(JSON.stringify(state));
        copy.id = uid();
        const list = JSON.parse(
          localStorage.getItem("lesson_projects") || "[]"
        );
        list.push(copy);
        localStorage.setItem("lesson_projects", JSON.stringify(list));
        populateProjects();
        $("#selProjects").value = copy.id;
        loadFromLocal(copy.id);
      }

      // ØªØ±Ø­ÙŠÙ„ Ø¥ØµØ¯Ø§Ø±Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©
      function migrateProject(p) {
        p.feedback = p.feedback || { text: "", images: [] };
        p.exercises = (p.exercises || []).map((ex) =>
          Object.assign(
            { prompt: "", solution: "", image: { url: "", data: "" } },
            ex
          )
        );

        p.quiz = (p.quiz || []).map((q) => {
          const Q = Object.assign(
            { text: "", image: { url: "", data: "" }, options: [], correct: 0 },
            q
          );

          Q.options = (Q.options || []).map((op) =>
            typeof op === "string"
              ? { text: op, comment: "", image: { url: "", data: "" } }
              : Object.assign(
                  { text: "", comment: "", image: { url: "", data: "" } },
                  op
                )
          );

          while (Q.options.length < 2)
            Q.options.push({
              text: "",
              comment: "",
              image: { url: "", data: "" },
            });

          return Q;
        });

        p.design = Object.assign(
          {
            primary: "#22c55e",
            font: "Segoe UI, Tahoma, Arial, sans-serif",
            rtl: true,
            fontData: "",
            fontName: "CustomFont",
          },
          p.design || {}
        );

        p.footer = Object.assign({ text: "" }, p.footer || {});
        p.branding = Object.assign(
          { logo: { url: "", data: "", alt: "" } },
          p.branding || {}
        );
      }

      // ===== Ø±Ø¨Ø· Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª =====
      function bindInputs() {
        // meta
        $("#title").value = state.meta.title;
        $("#subject").value = state.meta.subject;
        $("#duration").value = state.meta.duration;
        $("#objectives").value = state.meta.objectives;
        $("#teacherNotes").value = state.meta.teacherNotes;

        $("#title").oninput = (e) => {
          state.meta.title = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#subject").oninput = (e) => {
          state.meta.subject = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#duration").oninput = (e) => {
          state.meta.duration = Number(e.target.value || 45);
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#objectives").oninput = (e) => {
          state.meta.objectives = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#teacherNotes").oninput = (e) => {
          state.meta.teacherNotes = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        // feedback
        $("#feedbackText").value = state.feedback.text;
        $("#feedbackText").oninput = (e) => {
          state.feedback.text = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        // ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø´Ø±Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØºØ°ÙŠØ©
        state.feedback.video ||= { url: "", mode: "link" };

        const vUrl = document.getElementById("feedbackVideoUrl");
        const vMode = document.getElementById("feedbackVideoMode");

        if (vUrl) {
          vUrl.value = state.feedback.video.url || "";
          vUrl.oninput = (e) => {
            state.feedback.video.url = e.target.value.trim();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };
        }
        if (vMode) {
          vMode.value = state.feedback.video.mode || "link";
          vMode.onchange = (e) => {
            state.feedback.video.mode = e.target.value;
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };
        }

        // design/publish
        $("#primaryColor").value = state.design.primary;
        $("#fontFamily").value = state.design.font;
        $("#rtl").value = String(!!state.design.rtl);

        $("#primaryColor").oninput = (e) => {
          state.design.primary = e.target.value;
          document.documentElement.style.setProperty(
            "--primary",
            e.target.value
          );
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#fontFamily").onchange = (e) => {
          state.design.font = e.target.value;
          document.body.style.fontFamily = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#rtl").onchange = (e) => {
          state.design.rtl = e.target.value === "true";
          document.documentElement.setAttribute(
            "dir",
            state.design.rtl ? "rtl" : "ltr"
          );
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        // font embed fields
        $("#fontName").value = state.design.fontName || "CustomFont";
        $("#fontName").oninput = (e) => {
          state.design.fontName = e.target.value || "CustomFont";
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#fontStatus").textContent = state.design.fontData
          ? "Ø®Ø· Ù…Ø¶Ù…Ù‘Ù†"
          : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø· Ù…Ø¶Ù…Ù‘Ù†";

        // footer
        $("#footerText").value = state.footer.text;
        $("#footerText").oninput = (e) => {
          state.footer.text = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        $("#teacherName").value = state.footer.teacher || "";
        $("#teacherName").oninput = (e) => {
          state.footer.teacher = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        // logo
        renderBrandLogoControls();
      }

      // ===== ØµÙˆØ±: ØªØ­ÙˆÙŠÙ„/Ø¥Ø±ÙØ§Ù‚/Ù„ØµÙ‚ =====
      function fileToDataURL(file) {
        return new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      }

      function attachImageInputs(
        imgObj,
        { urlInput, fileInput, pasteZone, preview }
      ) {
        const refresh = () => {
          if (preview) preview.src = imgObj.data || imgObj.url || "";
        };

        if (urlInput) {
          urlInput.value = imgObj.url || "";
          urlInput.oninput = (e) => {
            imgObj.url = e.target.value;
            refresh();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };
        }

        if (fileInput) {
          fileInput.onchange = async (e) => {
            const f = e.target.files?.[0];
            if (!f) return;
            imgObj.data = await fileToDataURL(f);
            imgObj.url = "";
            refresh();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };
        }

        if (pasteZone) {
          pasteZone.addEventListener("paste", async (e) => {
            const items = e.clipboardData?.items || [];
            for (const it of items) {
              if (it.type?.startsWith("image/")) {
                const f = it.getAsFile();
                if (f) {
                  imgObj.data = await fileToDataURL(f);
                  imgObj.url = "";
                  refresh();
                  status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
                  break;
                }
              }
            }
          });

          // Ø¯Ø¹Ù… Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„ØµÙˆØ±
          pasteZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            pasteZone.style.borderColor = "var(--primary)";
            pasteZone.style.background = "rgba(34, 197, 94, 0.1)";
          });

          pasteZone.addEventListener("dragleave", (e) => {
            e.preventDefault();
            pasteZone.style.borderColor = "";
            pasteZone.style.background = "";
          });

          pasteZone.addEventListener("drop", async (e) => {
            e.preventDefault();
            pasteZone.style.borderColor = "";
            pasteZone.style.background = "";

            const files = Array.from(e.dataTransfer.files);
            for (const f of files) {
              if (f.type.startsWith("image/")) {
                imgObj.data = await fileToDataURL(f);
                imgObj.url = "";
                refresh();
                status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
                break;
              }
            }
          });
        }

        refresh();
      }

      // ===== ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©: ØµÙˆØ± =====
      function renderFeedbackImages() {
        const wrap = $("#feedbackImages");
        wrap.innerHTML = "";

        state.feedback.images.forEach((img, idx) => {
          const node = document.importNode(
            $("#tpl-feedback-img").content,
            true
          );
          const url = node.querySelector(".img-url");
          const alt = node.querySelector(".img-alt");
          const prev = node.querySelector(".img-preview");
          const file = node.querySelector(".img-file");
          const paste = node.querySelector(".img-paste");
          const del = node.querySelector(".btn-remove");

          alt.value = img.alt || "";
          alt.oninput = (e) => {
            img.alt = e.target.value;
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          attachImageInputs(img, {
            urlInput: url,
            fileInput: file,
            pasteZone: paste,
            preview: prev,
          });

          del.onclick = () => {
            state.feedback.images.splice(idx, 1);
            renderFeedbackImages();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          wrap.appendChild(node);
        });
      }

      $("#btnAddFeedbackImg").onclick = () => {
        state.feedback.images.push({ url: "", alt: "", data: "" });
        renderFeedbackImages();
        status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
      };

      // ===== ØªÙ…Ø§Ø±ÙŠÙ† (Ù…Ø¹ ØµÙˆØ±Ø©) =====
      function renderExercises() {
        const wrap = $("#exercisesList");
        wrap.innerHTML = "";

        state.exercises.forEach((ex, idx) => {
          const node = document.importNode($("#tpl-exercise").content, true);
          const p = node.querySelector(".ex-prompt");
          const s = node.querySelector(".ex-solution");
          const u = node.querySelector(".ex-img-url");
          const f = node.querySelector(".ex-img-file");
          const pz = node.querySelector(".ex-img-paste");
          const prev = node.querySelector(".ex-img-preview");

          p.value = ex.prompt || "";
          s.value = ex.solution || "";

          p.oninput = (e) => {
            ex.prompt = e.target.value;
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          s.oninput = (e) => {
            ex.solution = e.target.value;
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          ex.image = ex.image || { url: "", data: "" };
          attachImageInputs(ex.image, {
            urlInput: u,
            fileInput: f,
            pasteZone: pz,
            preview: prev,
          });

          node.querySelector(".btn-remove").onclick = () => {
            state.exercises.splice(idx, 1);
            renderExercises();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          node.querySelector(".btn-move-up").onclick = () => {
            if (idx > 0) {
              const t = state.exercises[idx - 1];
              state.exercises[idx - 1] = ex;
              state.exercises[idx] = t;
              renderExercises();
              status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
            }
          };

          node.querySelector(".btn-move-down").onclick = () => {
            if (idx < state.exercises.length - 1) {
              const t = state.exercises[idx + 1];
              state.exercises[idx + 1] = ex;
              state.exercises[idx] = t;
              renderExercises();
              status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
            }
          };

          wrap.appendChild(node);
        });
      }

      $("#btnAddExercise").onclick = () => {
        state.exercises.push({
          prompt: "",
          solution: "",
          image: { url: "", data: "" },
        });

        renderExercises();
        status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
      };

      // ===== ÙƒÙˆÙŠØ² (Ø®ÙŠØ§Ø±Ø§Øª ÙˆØµÙˆØ±) =====
      function updateCorrectSelect(selectEl, q) {
        selectEl.innerHTML = "";
        q.options.forEach((_, i) => {
          const op = document.createElement("option");
          op.value = String(i);
          op.textContent = String(i + 1);
          selectEl.appendChild(op);
        });

        if (q.correct >= q.options.length) q.correct = 0;
        selectEl.value = String(q.correct);
      }

      function renderQuiz() {
        const wrap = $("#quizList");
        wrap.innerHTML = "";

        state.quiz.forEach((q, idx) => {
          const node = document.importNode($("#tpl-question").content, true);
          const qtext = node.querySelector(".q-text");
          const qUrl = node.querySelector(".q-img-url");
          const qFile = node.querySelector(".q-img-file");
          const qPaste = node.querySelector(".q-img-paste");
          const qCorrect = node.querySelector(".q-correct");
          const tbody = node.querySelector(".q-options-body");

          // ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†ÙŠØ© Ø§Ù„Ø³Ø¤Ø§Ù„
          q.image = q.image || { url: "", data: "" };
          q.options = (q.options || []).map((op) =>
            Object.assign(
              { text: "", comment: "", image: { url: "", data: "" } },
              op
            )
          );

          while (q.options.length < 2)
            q.options.push({
              text: "",
              comment: "",
              image: { url: "", data: "" },
            });

          // Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØµÙˆØ±ØªÙ‡
          qtext.value = q.text || "";
          qtext.oninput = (e) => {
            q.text = e.target.value;
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          attachImageInputs(q.image, {
            urlInput: qUrl,
            fileInput: qFile,
            pasteZone: qPaste,
            preview: null,
          });

          // Ø±Ø³Ù… Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ (Ù…Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚)
          function renderOptions() {
            tbody.innerHTML = "";
            q.options.forEach((opt, oi) => {
              const row = document.importNode(
                $("#tpl-option-row").content,
                true
              );
              row.querySelector(".opt-index").textContent = String(oi + 1);

              const t = row.querySelector(".opt-text");
              const cmt = row.querySelector(".opt-comment");
              const u = row.querySelector(".opt-img-url");
              const f = row.querySelector(".opt-img-file");
              const pz = row.querySelector(".opt-img-paste");

              // Ù‚ÙŠÙ… Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚ + Ø§Ù„Ø±Ø¨Ø·
              t.value = opt.text || "";
              t.oninput = (e) => {
                opt.text = e.target.value;
                status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
              };

              opt.comment ??= "";
              cmt.value = opt.comment;
              cmt.oninput = (e) => {
                opt.comment = e.target.value;
                status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
              };

              // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
              const preview = new Image();
              preview.style.cssText =
                "display:block;max-width:220px;max-height:80px;border:1px solid #243041;border-radius:8px;margin-top:6px";
              row.querySelector("td:nth-child(3)").appendChild(preview);

              opt.image = opt.image || { url: "", data: "" };
              attachImageInputs(opt.image, {
                urlInput: u,
                fileInput: f,
                pasteZone: pz,
                preview,
              });

              // Ø­Ø°Ù Ø®ÙŠØ§Ø±
              row.querySelector(".btn-remove-option").onclick = () => {
                if (q.options.length <= 2) {
                  alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø®ÙŠØ§Ø±Ø§Ù†");
                  return;
                }

                q.options.splice(oi, 1);
                if (q.correct === oi) q.correct = 0;
                else if (q.correct > oi) q.correct--;

                renderOptions();
                updateCorrectSelect(qCorrect, q);
                status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
              };

              tbody.appendChild(row);
            });
          }

          renderOptions();
          updateCorrectSelect(qCorrect, q);

          // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ comment Ø§ÙØªØ±Ø§Ø¶ÙŠ)
          node.querySelector(".btn-add-option").onclick = () => {
            if (q.options.length >= 6) {
              alert("Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 6 Ø®ÙŠØ§Ø±Ø§Øª");
              return;
            }

            q.options.push({
              text: "",
              comment: "",
              image: { url: "", data: "" },
            });

            renderOptions();
            updateCorrectSelect(qCorrect, q);
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          qCorrect.onchange = (e) => {
            q.correct = Number(e.target.value || 0);
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          // Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
          node.querySelector(".btn-remove").onclick = () => {
            state.quiz.splice(idx, 1);
            renderQuiz();
            status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
          };

          node.querySelector(".btn-move-up").onclick = () => {
            if (idx > 0) {
              const t = state.quiz[idx - 1];
              state.quiz[idx - 1] = q;
              state.quiz[idx] = t;
              renderQuiz();
              status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
            }
          };

          node.querySelector(".btn-move-down").onclick = () => {
            if (idx < state.quiz.length - 1) {
              const t = state.quiz[idx + 1];
              state.quiz[idx + 1] = q;
              state.quiz[idx] = t;
              renderQuiz();
              status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
            }
          };

          wrap.appendChild(node);
        });
      }

      $("#btnAddQuestion").onclick = () => {
        state.quiz.push({
          text: "",
          image: { url: "", data: "" },
          options: [
            { text: "", comment: "", image: { url: "", data: "" } },
            { text: "", comment: "", image: { url: "", data: "" } },
          ],
          correct: 0,
        });

        renderQuiz();
        status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
      };

      // ØªØ¨ÙˆÙŠØ¨
      $$(".tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          $$(".tab").forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          const id = tab.dataset.tab;
          $$('section[role="tabpanel"]').forEach(
            (sec) => (sec.hidden = sec.id !== `tab-${id}`)
          );

          // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
          updateProgress();
        });
      });

      // ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±
      async function fetchToDataURL(url) {
        try {
          const res = await fetch(url, { mode: "cors" });
          const blob = await res.blob();
          return await fileToDataURL(blob);
        } catch {
          return null;
        }
      }

      async function inlineProject(src) {
        const data = JSON.parse(JSON.stringify(src));

        // ØªØºØ°ÙŠØ©
        for (const img of data.feedback.images || []) {
          if (img.url && !img.data && !isDataUrl(img.url)) {
            const d = await fetchToDataURL(img.url);
            if (d) {
              img.data = d;
              img.url = "";
            }
          }
        }

        // ØªÙ…Ø§Ø±ÙŠÙ†
        for (const ex of data.exercises || []) {
          if (ex.image?.url && !ex.image.data && !isDataUrl(ex.image.url)) {
            const d = await fetchToDataURL(ex.image.url);
            if (d) {
              ex.image.data = d;
              ex.image.url = "";
            }
          }
        }

        // Ø£Ø³Ø¦Ù„Ø© ÙˆØ®ÙŠØ§Ø±Ø§Øª
        for (const q of data.quiz || []) {
          if (q.image?.url && !q.image.data && !isDataUrl(q.image.url)) {
            const d = await fetchToDataURL(q.image.url);
            if (d) {
              q.image.data = d;
              q.image.url = "";
            }
          }

          for (const op of q.options || []) {
            if (op.image?.url && !op.image.data && !isDataUrl(op.image.url)) {
              const d = await fetchToDataURL(op.image.url);
              if (d) {
                op.image.data = d;
                op.image.url = "";
              }
            }
          }
        }

        // Ø´Ø¹Ø§Ø±
        if (
          data.branding?.logo?.url &&
          !data.branding.logo.data &&
          !isDataUrl(data.branding.logo.url)
        ) {
          const d = await fetchToDataURL(data.branding.logo.url);
          if (d) {
            data.branding.logo.data = d;
            data.branding.logo.url = "";
          }
        }

        return data;
      }

      const getImgSrc = (img) => img?.data || img?.url || "";

      // ØªÙˆÙ„ÙŠØ¯ ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
      function generateStudentHTMLSync(data) {
        const { meta, feedback, exercises, quiz, design, footer, branding } =
          data;
        const dir = design.rtl ? "rtl" : "ltr";
        const primary = design.primary || "#22c55e";
        const font = design.font || "Segoe UI, Tahoma, Arial, sans-serif";

        // Ø´Ø¹Ø§Ø±: Ù…Ø³Ø§Ø± Ù…Ø±Ù† (ÙŠØ¯Ø¹Ù… string Ø£Ùˆ object)
        const logoSrc = (function () {
          const l = branding?.logo;
          if (!l) return "";
          if (typeof l === "string") return l;
          return getImgSrc(l) || l.url || "";
        })();
        const logoAlt = toArabicDigits(
          escapeHtml(branding?.logo?.alt || "Ø´Ø¹Ø§Ø±")
        );

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        const quizItems = (quiz || [])
          .map((q, qi) => {
            const qImgSrc = getImgSrc(q.image || {});
            const qImg = qImgSrc
              ? '<img src="' +
                qImgSrc +
                '" alt="ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„" style="max-width:100%; border-radius:10px; border:1px solid #e5e7eb"/>'
              : "";

            const options = (q.options || [])
              .slice(0, 6)
              .map((op, oi) => {
                const oSrc = getImgSrc(op.image || {});
                const imgTag = oSrc
                  ? '<img src="' +
                    oSrc +
                    '" alt="ØµÙˆØ±Ø© Ø§Ù„Ø®ÙŠØ§Ø±" style="max-width:100%; max-height:120px; border-radius:8px; border:1px solid #e5e7eb; display:block; margin-top:6px"/>'
                  : "";

                return (
                  '<button class="opt" data-qi="' +
                  qi +
                  '" data-oi="' +
                  oi +
                  '" data-comment="' +
                  toArabicDigits(escapeHtml(op.comment || "")) +
                  '" aria-pressed="false"><span class="letter">' +
                  String.fromCharCode(0x0661 + oi) +
                  '</span><span class="txt">' +
                  toArabicDigits(escapeHtml(op.text || "")) +
                  "</span>" +
                  imgTag +
                  "</button>"
                );
              })
              .join("");

            return (
              '<article class="q-item" data-correct="' +
              Number(q.correct || 0) +
              '"><div class="q-head"><b>Ø³Ø¤Ø§Ù„ ' +
              toArabicDigits(qi + 1) +
              ':</b></div><div class="q-text">' +
              toArabicDigits(escapeHtml(q.text || "")) +
              "</div>" +
              qImg +
              '<div class="q-options" role="group" aria-label="Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„">' +
              options +
              '</div><div class="q-feedback" hidden></div></article>'
            );
          })
          .join("\n");

        // @font-face Ø¥Ù† ÙˆÙØ¬Ø¯ Ø®Ø· Ù…Ø¶Ù…Ù‘Ù†
        const fontFace = design.fontData
          ? "@font-face{font-family:'" +
            escapeHtml(design.fontName || "CustomFont") +
            "'; src:url(" +
            design.fontData +
            ") format('woff2'); font-display:swap}"
          : "";

        const usedFont = design.fontData
          ? "'" + escapeHtml(design.fontName || "CustomFont") + "', " + font
          : font;

        const parts = [];
        parts.push("<!doctype html>");
        parts.push('<html lang="ar" dir="' + dir + '">');
        parts.push("<head>");
        parts.push('  <meta charset="utf-8" />');
        parts.push(
          '  <meta name="viewport" content="width=device-width,initial-scale=1" />'
        );
        parts.push(
          "  <title>" +
            toArabicDigits(escapeHtml(meta.title || "Ø¯Ø±Ø³")) +
            "</title>"
        );
        parts.push("  <style>");
        parts.push("    " + fontFace);
        parts.push(
          "    :root{ --primary:" +
            primary +
            "; --radius:16px; --text:#0b1220; --muted:#334155; }"
        );
        parts.push(
          "    body{font-family:" +
            usedFont +
            "; margin:0; background:#f8fafc; color:#0b1220;}"
        );
        parts.push("    :where(button,input,select,textarea){ font: inherit }");
        parts.push("    .q-options .opt{ font: inherit }");

        parts.push("    .shell{max-width:980px; margin:auto; padding:24px}");
        parts.push(
          "    header{position:sticky; top:0; background:linear-gradient(180deg,#fff, #f8fafc); border-bottom:1px solid #e5e7eb; z-index:10}"
        );
        parts.push(
          "    .h-wrap{display:grid; grid-template-columns:1fr auto; align-items:center; gap:16px; padding:12px 24px}"
        );
        parts.push("    .hdr-right h1{margin:8px 0 12px}");
        parts.push(
          "    .logo{max-height:56px; width:auto; border:1px solid #e5e7eb; border-radius:8px; object-fit:contain; background:#fff; padding:4px; margin-inline-start:12px}"
        );
        parts.push(
          "    .badge{background:#ecfeff; color:#155e75; border:1px solid #bae6fd; padding:2px 8px; border-radius:999px; font-size:12px}"
        );
        parts.push("    nav{display:flex; gap:8px; flex-wrap:wrap}");
        parts.push(
          "    nav a{padding:8px 12px; border-radius:999px; border:1px solid #e5e7eb; text-decoration:none; color:#111827}"
        );
        parts.push("    nav a:hover{border-color:var(--primary)}");
        parts.push(
          "    section{background:#fff; border:1px solid #e5e7eb; border-radius:var(--radius); padding:18px 18px; margin:16px 0}"
        );
        parts.push(
          "    .section-sep{border:none; border-top:3px double #e5e7eb; margin:26px 0}"
        );
        parts.push(
          "    .title{font-weight:800; font-size:20px; margin-bottom:12px}"
        );
        parts.push("    .objectives li{margin:6px 0}");
        parts.push(
          "    .ex{border:1px dashed #d1d5db; border-radius:12px; padding:12px; margin:10px 0}"
        );
        parts.push(
          "    .ex .sol{background:#f1f5f9; border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-top:8px}"
        );
        parts.push(
          "    .q-item{border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:12px 0}"
        );
        parts.push("    .q-head{margin-bottom:6px}");
        parts.push("    .q-text{font-weight:700; margin-bottom:10px}");
        parts.push(
          "    .q-options{display:grid; grid-template-columns:1fr 1fr; gap:8px}"
        );
        parts.push(
          "    .q-options .opt{display:flex; gap:8px; align-items:flex-start; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px; padding:10px; cursor:pointer}"
        );
        parts.push(
          '    .q-options .opt[aria-pressed="true"]{outline:2px solid var(--primary)}'
        );
        parts.push(
          "    .q-options .letter{display:inline-flex; width:28px; height:28px; border-radius:8px; align-items:center; justify-content:center; background:#eef2ff}"
        );
        parts.push("    .q-feedback{margin-top:8px; font-weight:700}");
        parts.push("    .ok{color:#15803d} .bad{color:#b91c1c}");
        parts.push("    .actions{display:flex; gap:8px; flex-wrap:wrap}");
        parts.push(
          "    .btn{appearance:none; border:1px solid #e5e7eb; background:var(--primary); color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer}"
        );
        parts.push("    .btn.secondary{background:#111827; color:#fff}");
        parts.push("    .muted{color:#475569; font-size:12px}");
        parts.push("    .video{ margin:10px 0 }");
        parts.push(
          "    .video-embed{ position:relative; padding-top:56.25%; background:#000; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden }"
        );
        parts.push(
          "    .video-embed iframe, .video-embed video{ position:absolute; inset:0; width:100%; height:100% }"
        );
        parts.push(
          "    .q-text, .q-options .txt, #result { overflow-wrap:anywhere; word-break:break-word; }"
        );
        parts.push(
          "    @media print { header, .actions, nav { display:none !important; } }"
        );
        parts.push("  </style>");
        parts.push("</head>");
        parts.push("<body>");

        /* Ø£Ù‚Ø³Ø§Ù… Ù…Ø´Ø±ÙˆØ·Ø© */
        const goalsList = (meta.objectives || "")
          .split(/\n+/)
          .map((s) => s.trim())
          .filter(Boolean);
        const goalsHTML = goalsList.length
          ? '    <section id="goals"><div class="title">Ø£Ù‡Ø¯Ø§Ù Ø§Ù„ØªØ¹Ù„Ù…</div><ul class="objectives">' +
            goalsList
              .map((x) => "<li>" + toArabicDigits(escapeHtml(x)) + "</li>")
              .join("") +
            '</ul><div class="muted">Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: ' +
            toArabicDigits(Number(meta.duration || 0)) +
            " Ø¯Ù‚ÙŠÙ‚Ø©</div></section>"
          : "";

        const videoHTML = buildVideoBlock(feedback.video);
        const fbTextHTML = (feedback.text || "").trim()
          ? paragraphs(toArabicDigits(feedback.text || ""))
          : "";
        const fbImgsHTML = (feedback.images || [])
          .map((img) => {
            const src = getImgSrc(img);
            return src
              ? '<figure style="margin:10px 0"><img src="' +
                  src +
                  '" alt="' +
                  escapeHtml(img.alt || "ØµÙˆØ±Ø©") +
                  '" style="max-width:100%; border-radius:12px; border:1px solid #e5e7eb"><figcaption class="muted">' +
                  toArabicDigits(escapeHtml(img.alt || "")) +
                  "</figcaption></figure>"
              : "";
          })
          .join("");

        const fbInner = [
          fbTextHTML,
          videoHTML ? '<hr class="section-sep" />' + videoHTML : "",
          fbImgsHTML,
        ]
          .filter(Boolean)
          .join("");
        const feedbackHTML = fbInner
          ? '    <section id="feedback"><div class="title">ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©</div>' +
            fbInner +
            "</section>"
          : "";

        const exItems = (exercises || [])
          .map((ex, i) => {
            const exImgSrc = getImgSrc(ex.image || {});
            const exImg = exImgSrc
              ? '<div style="margin:8px 0"><img src="' +
                exImgSrc +
                '" alt="ØµÙˆØ±Ø© Ø§Ù„ØªÙ…Ø±ÙŠÙ†" style="max-width:100%; border:1px solid #e5e7eb; border-radius:10px"/></div>'
              : "";
            return (
              '<article class="ex"><div><b>ØªÙ…Ø±ÙŠÙ† ' +
              toArabicDigits(i + 1) +
              ":</b> " +
              toArabicDigits(escapeHtml(ex.prompt || "")) +
              "</div>" +
              exImg +
              '<details class="sol"><summary>Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù„</summary><div>' +
              toArabicDigits(escapeHtml(ex.solution || "")) +
              "</div></details></article>"
            );
          })
          .join("");
        const exercisesHTML =
          exercises && exercises.length
            ? '    <section id="exercises"><div class="title">ØªÙ…Ø§Ø±ÙŠÙ† ØªØ¯Ø±ÙŠØ¨ ÙˆÙ…Ø­Ù„ÙˆÙ„Ø©</div>' +
              exItems +
              "</section>"
            : "";

        const quizHTML =
          quiz && quiz.length
            ? '    <section id="quiz"><div class="title">Ø§Ø®ØªØ¨Ø§Ø± Ù‚ØµÙŠØ±</div><div id="quizWrap">' +
              quizItems +
              '</div><div class="actions"><button id="btnSubmit" class="btn">ØªØµØ­ÙŠØ­</button><button id="btnReset" class="btn secondary">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button><button id="btnCert" class="btn" style="display:none">Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</button><div id="result" class="muted"></div></div></section>'
            : "";

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„: Ù…Ø­ØªÙˆÙ‰ ÙÙ‚Ø· Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù† */
        const footerHTML = (footer?.text || "").trim()
          ? '    <section id="footer">' +
            paragraphs(toArabicDigits(footer.text || "")) +
            "</section>"
          : "";

        /* Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙÙŠ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù) */
        const navLinks = [];
        if (goalsHTML) navLinks.push('<a href="#goals">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</a>');
        if (feedbackHTML) navLinks.push('<a href="#feedback">ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø©</a>');
        if (exercisesHTML) navLinks.push('<a href="#exercises">ØªÙ…Ø§Ø±ÙŠÙ†</a>');
        if (quizHTML) navLinks.push('<a href="#quiz">Ø§Ø®ØªØ¨Ø§Ø±</a>');

        /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
        parts.push("  <header>");
        parts.push('    <div class="h-wrap">');
        parts.push('      <div class="hdr-right">');
        parts.push(
          '        <div class="badge">ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù…ÙƒØªÙÙŠØ© Ø°Ø§ØªÙŠÙ‹Ø§)</div>'
        );
        parts.push(
          '        <div class="muted">' +
            toArabicDigits(escapeHtml(meta.subject || "")) +
            "</div>"
        );
        parts.push(
          "        <h1>" +
            toArabicDigits(escapeHtml(meta.title || "Ø¯Ø±Ø³")) +
            "</h1>"
        );
        parts.push(
          navLinks.length
            ? '        <nav aria-label="Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹">' +
                navLinks.join("") +
                "</nav>"
            : ""
        );
        parts.push("      </div>");
        parts.push(
          logoSrc
            ? '<img class="logo" src="' + logoSrc + '" alt="' + logoAlt + '"/>'
            : ""
        );
        parts.push("    </div>");
        parts.push("  </header>");

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù…Ø¹ ÙÙˆØ§ØµÙ„ ÙÙ‚Ø· Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ù‚Ø³Ù… */
        const sections = [
          goalsHTML,
          feedbackHTML,
          exercisesHTML,
          quizHTML,
          footerHTML,
        ].filter(Boolean);
        parts.push('  <div class="shell">');
        if (sections.length) {
          parts.push(sections.join('\n    <hr class="section-sep" />\n'));
        }
        parts.push("  </div>");

        parts.push("  <script>");
        parts.push(
          "    const TEACHER_NAME = " +
            JSON.stringify(footer?.teacher || "") +
            ";"
        );
        parts.push(
          '    function toArabicDigits(x){ return String(x).replace(/\\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]); }'
        );

        // Ø²Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (Ù†Ø§ÙØ°Ø© PDF)
        parts.push(
          "    function openCertificate(){" +
            '      var student = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:"); if(!student) return; student = student.trim();' +
            '      var DIR = document.documentElement.getAttribute("dir") || "rtl";' +
            '      var PRIMARY = getComputedStyle(document.documentElement).getPropertyValue("--primary").trim() || "#22c55e";' +
            '      var FONT = getComputedStyle(document.body).fontFamily || "Segoe UI, Tahoma, Arial, sans-serif";' +
            '      var logoEl = document.querySelector(".logo"); var logo = (logoEl && logoEl.getAttribute("src")) || "";' +
            '      var subject = (document.querySelector(".hdr-right .muted")||{}).textContent || "";' +
            '      var title = (document.querySelector(".hdr-right h1")||{}).textContent || "";' +
            '      var quizHtml = (document.getElementById("quizWrap")||{}).innerHTML || "";' +
            '      var resultTxt = (document.getElementById("result")||{}).textContent || "";' +
            '      function esc(s){ return String(s).replace(/[&<>\\"]/g,function(ch){return {"&":"&amp;","<":"&lt;",">":"&gt;","\\"":"&quot;"}[ch]||ch;}); }' +
            '      var html="";' +
            '      html += "<!doctype html>";' +
            '      html += "<html lang=\\"ar\\" dir=\\"" + DIR + "\\">";' +
            '      html += "<head><meta charset=\\"utf-8\\"><meta name=\\"viewport\\" content=\\"width=device-width,initial-scale=1\\">";' +
            '      html += "<title>Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø²</title>";' +
            '      html += "<style>@page{size:A4; margin:12mm} :root{--primary:" + PRIMARY + ";--radius:16px} body{font-family:" + FONT + ";margin:0;color:#0b1220;background:#fff;line-height:1.5} .shell{max-width:900px;margin:auto;padding:8mm} @media print{.shell{padding:0}} .head3{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px} .head3 .center{font-weight:900;font-size:20px;text-align:center} h1{font-size:16px;margin:6px 0 0;text-align:center} .logo{max-height:48px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;padding:3px;justify-self:start;margin-left:6mm} .subject{justify-self:end} .section-sep{border:none;border-top:2px solid #e5e7eb;margin:14px 0} section, .q-item{break-inside:avoid;page-break-inside:avoid} .q-item{border:1px solid #e5e7eb;border-radius:12px;padding:8px;margin:8px 0} .q-text{font-weight:700;font-size:14px;margin-bottom:6px} .q-options{display:grid;grid-template-columns:1fr 1fr;gap:6px} .q-options .opt{display:flex;gap:6px;align-items:flex-start;background:#f8fafc;border:1px solid #e5e7eb;border-radius:10px;padding:8px} .q-options .opt[aria-pressed=\\"true\\"]{outline:2px solid var(--primary)} .q-options .letter{display:inline-flex;width:24px;height:24px;border-radius:8px;align-items:center;justify-content:center;background:#eef2ff;font-size:13px} .q-feedback{margin-top:6px;font-weight:700} .ok{color:#15803d}.bad{color:#b91c1c} .sign-row{display:flex;justify-content:space-between;margin-top:12px} .muted{color:#475569;font-size:12px}</style>";' +
            '      html += "</head><body><div class=\\"shell\\">";' +
            '      html += "<div class=\\"head3\\">" + (logo? "<img class=\\"logo\\" src=\\"" + esc(logo) + "\\" alt=\\"Ø´Ø¹Ø§Ø±\\"/>" : "<div class=\\"logo\\"></div>") + "<div class=\\"center\\">Ø´Ù‡Ø§Ø¯Ø© Ø¥Ù†Ø¬Ø§Ø² Ø·Ø§Ù„Ø¨ / Ø·Ø§Ù„Ø¨Ø©</div><div class=\\"subject muted\\">" + esc(subject) + "</div></div>";' +
            '      html += "<h1>" + esc(title) + "</h1>";' +
            '      html += "<hr class=\\"section-sep\\">";' +
            '      html += "<section><div class=\\"title\\" style=\\"font-size:18px;margin-bottom:8px\\">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚ØµÙŠØ±</div><div id=\\"quizCopy\\">" + quizHtml + "</div><div class=\\"muted\\" style=\\"margin-top:8px\\">" + esc(resultTxt) + "</div></section>";' +
            '      html += "<hr class=\\"section-sep\\">";' +
            '      html += "<section><div class=\\"sign-row\\"><div><b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ù€Ø©:</b> " + esc(student) + "</div><div><b>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ù€Ø©:</b> " + esc(TEACHER_NAME) + "</div></div></section>";' +
            '      html += "<div class=\\"print-hint muted\\">Ø§Ø®ØªØ± \\"Ø­ÙØ¸ ÙƒÙ…Ù„Ù PDF\\" Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>";' +
            '      html += "</div><script>window.print()<" + "/script></body></html>";' +
            '      var w = window.open("", "_blank"); if(!w || !w.document){ alert("Ù„Ù… Ø£Ø³ØªØ·Ø¹ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©. Ø¹Ø·Ù‘Ù„ Ø­Ø§Ø¬Ø¨ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©."); return; } w.document.open(); w.document.write(html); w.document.close();' +
            "    }"
        );

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø± Ø¨Ø§Ù„ÙˆÙØ¯ (delegation)
        parts.push(
          '    document.addEventListener("click", function(e){ var btn=e.target.closest(".opt"); if(!btn||!btn.closest("#quizWrap")) return; var group=btn.parentElement.querySelectorAll(".opt"); group.forEach(function(b){ b.setAttribute("aria-pressed","false"); }); btn.setAttribute("aria-pressed","true"); });'
        );

        // Ø§Ù„ØªØµØ­ÙŠØ­ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
        parts.push(
          '    function grade(){ const items = Array.from(document.querySelectorAll(".q-item")); var correct=0, answered=0; items.forEach((item)=>{ const sel = item.querySelector(".opt[aria-pressed=\\"true\\"]"); const fb = item.querySelector(".q-feedback"); fb.hidden=false; if(!sel){ fb.textContent="Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø©"; fb.className="q-feedback bad"; return } answered++; const oi = Number(sel.dataset.oi||0); const ci = Number(item.dataset.correct||0); const cm = sel.dataset.comment || ""; if(oi===ci){ correct++; fb.textContent="Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© âœ“" + (cm ? " (" + cm + ")" : ""); fb.className="q-feedback ok" } else { fb.textContent="Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© âœ—" + (cm ? " (" + cm + ")" : ""); fb.className="q-feedback bad" } }); var pct = items.length? Math.round((correct/items.length)*100):0; var resEl=document.getElementById("result"); if(resEl){ resEl.textContent = "Ù†ØªÙŠØ¬ØªÙƒ: " + toArabicDigits(correct) + " / " + toArabicDigits(items.length) + " ("+ toArabicDigits(pct) +"%)" + (answered<items.length? " â€” (" + toArabicDigits(items.length-answered) + " Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ù…Ø¬Ø§Ø¨ Ø¹Ù†Ù‡Ø§)" : ""); } var cert=document.getElementById("btnCert"); if(cert) cert.style.display = (correct===items.length && items.length>0) ? "inline-flex" : "none"; }'
        );

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        parts.push(
          '    function resetQuiz(){ document.querySelectorAll(".opt[aria-pressed=\\"true\\"]").forEach(b=>b.setAttribute("aria-pressed","false")); document.querySelectorAll(".q-feedback").forEach(f=>{f.hidden=true; f.textContent=""}); var res=document.getElementById("result"); if(res) res.textContent=""; var cert=document.getElementById("btnCert"); if(cert) cert.style.display="none"; }'
        );

        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø´Ø±Ø· ÙˆØ¬ÙˆØ¯Ù‡Ø§ (Ù…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ null)
        parts.push(
          '    (function(){ var s=document.getElementById("btnSubmit"); if(s) s.addEventListener("click", grade); var r=document.getElementById("btnReset"); if(r) r.addEventListener("click", resetQuiz); var c=document.getElementById("btnCert"); if(c) c.addEventListener("click", openCertificate); })();'
        );

        parts.push(
          '    window.addEventListener("beforeprint", ()=>{ document.querySelectorAll("details.sol").forEach(d=> d.open=true); });'
        );
        parts.push("  <" + "/script>");
        parts.push("</body>");
        parts.push("</html>");

        return parts.join("\n");

        // ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        function buildVideoBlock(v) {
          if (!v) return "";
          const urlRaw = (v.url || "").trim();
          const urlEsc = escapeHtml(urlRaw);

          if (v.mode !== "embed") {
            return urlRaw
              ? '<p><a href="' +
                  urlEsc +
                  '" target="_blank" rel="noopener">Ø±Ø§Ø¨Ø· Ø´Ø±Ø­ ÙÙŠØ¯ÙŠÙˆ</a></p>'
              : "";
          }

          if (!urlRaw) return "";

          // YouTube
          let m = urlRaw.match(
            /(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([A-Za-z0-9_-]{6,})/i
          );
          if (m) {
            const id = m[1];
            return (
              '<div class="video"><div class="video-embed">' +
              '<iframe src="https://www.youtube-nocookie.com/embed/' +
              id +
              '" title="YouTube video" frameborder="0" ' +
              'allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" ' +
              'allowfullscreen loading="lazy"></iframe></div>' +
              '<div class="muted">Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ <a href="' +
              urlEsc +
              '" target="_blank" rel="noopener">Ø§ÙØªØ­Ù‡ Ù‡Ù†Ø§</a></div></div>'
            );
          }

          // Vimeo
          m = urlRaw.match(/vimeo\.com\/(?:video\/)?(\d+)/i);
          if (m) {
            const id = m[1];
            return (
              '<div class="video"><div class="video-embed">' +
              '<iframe src="https://player.vimeo.com/video/' +
              id +
              '" frameborder="0" ' +
              'allow="autoplay; fullscreen; picture-in-picture" allowfullscreen loading="lazy"></iframe></div>' +
              '<div class="muted">Ø¥Ù† Ù„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ <a href="' +
              urlEsc +
              '" target="_blank" rel="noopener">Ø§ÙØªØ­Ù‡ Ù‡Ù†Ø§</a></div></div>'
            );
          }

          // Ù…Ù„ÙØ§Øª ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø©
          if (
            /\.(mp4|webm|ogg)(\?.*)?$/i.test(urlRaw) ||
            urlRaw.startsWith("data:video")
          ) {
            const type = urlRaw.endsWith(".webm")
              ? "video/webm"
              : urlRaw.endsWith(".ogg")
              ? "video/ogg"
              : "video/mp4";
            return (
              '<div class="video"><div class="video-embed">' +
              '<video controls preload="metadata"><source src="' +
              urlEsc +
              '" type="' +
              type +
              '">' +
              'Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ. <a href="' +
              urlEsc +
              '" target="_blank" rel="noopener">Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</a></video></div></div>'
            );
          }

          // ØªØ¶Ù…ÙŠÙ† Ø¹Ø§Ù…
          return (
            '<div class="video"><div class="video-embed">' +
            '<iframe src="' +
            urlEsc +
            '" frameborder="0" allowfullscreen loading="lazy"></iframe></div>' +
            '<div class="muted">Ù‚Ø¯ ÙŠØ±ÙØ¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ¶Ù…ÙŠÙ†. Ø§Ø³ØªØ®Ø¯Ù… <a href="' +
            urlEsc +
            '" target="_blank" rel="noopener">Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</a> Ø¥Ù† Ù„Ø²Ù….</div></div>'
          );
        }
      }

      // ØªÙˆÙ„ÙŠØ¯/Ù…Ø¹Ø§ÙŠÙ†Ø©
      async function exportStudent(kind) {
        const inlined = await inlineProject(state);
        const html = generateStudentHTMLSync(inlined);
        const blob = new Blob([html], { type: "text/html" });
        const url = URL.createObjectURL(blob);

        if (kind === "download") {
          const a = document.createElement("a");
          a.href = url;
          a.download =
            (state.meta.title
              ? state.meta.title.replace(/\s+/g, "-")
              : "lesson") + ".html";
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        } else {
          window.open(url, "_blank");
          setTimeout(() => URL.revokeObjectURL(url), 10000);
        }
      }

      // JSON & Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
      $("#btnExportHTML").onclick = () => exportStudent("download");
      $("#btnPreview").onclick = () => exportStudent("preview");
      $("#btnExportHTML2").onclick = () => exportStudent("download");
      $("#btnPreview2").onclick = () => exportStudent("preview");

      $("#btnExportJSON").onclick = () => {
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = (state.meta.title || "project") + ".json";
        a.click();
        URL.revokeObjectURL(a.href);
      };

      $("#btnImportJSON").onclick = () => $("#importFile").click();

      $("#importFile").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const text = await file.text();
        try {
          const obj = JSON.parse(text);
          migrateProject(obj);
          state = obj;
          renderAll();
          status("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯", true);
        } catch (err) {
          alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: " + err.message);
        }
      });

      // Ù…Ø´Ø§Ø±ÙŠØ¹
      $("#btnNew").onclick = () => {
        if (
          state.meta.title ||
          state.exercises.length > 0 ||
          state.quiz.length > 0
        ) {
          if (
            !confirm(
              "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ØŸ Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©."
            )
          ) {
            return;
          }
        }

        state = emptyState();
        renderAll();
        status("Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ (ØºÙŠØ± Ù…Ø­ÙÙˆØ¸)");
      };

      $("#btnSave").onclick = saveToLocal;

      $("#btnLoad").onclick = () => {
        const id = $("#selProjects").value;
        if (id) loadFromLocal(id);
      };

      $("#btnDelete").onclick = () => {
        const id = $("#selProjects").value;
        if (!id) return;

        if (confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) {
          deleteFromLocal(id);
          if (state.id === id) {
            state = emptyState();
            renderAll();
          }
        }
      };

      $("#btnDuplicate").onclick = duplicateProject;

      // Ø±ÙØ¹ Ø§Ù„Ø®Ø·
      $("#fontFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;

        state.design.fontData = await new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.onerror = rej;
          r.readAsDataURL(f);
        });

        state.design.fontName = $("#fontName").value || "CustomFont";
        status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        $("#fontStatus").textContent = "Ø®Ø· Ù…Ø¶Ù…Ù‘Ù†";
      });

      // Ø´Ø¹Ø§Ø±: Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„
      function renderBrandLogoControls() {
        const wrap = $("#brandLogoWrap");
        const url = wrap.querySelector(".logo-url");
        const file = wrap.querySelector(".logo-file");
        const pz = wrap.querySelector(".logo-paste");
        const prev = wrap.querySelector(".logo-preview");
        const alt = wrap.querySelector(".logo-alt");

        const logo =
          state.branding.logo ||
          (state.branding.logo = { url: "", data: "", alt: "" });
        alt.value = logo.alt || "";

        alt.oninput = (e) => {
          logo.alt = e.target.value;
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        const refresh = () => {
          prev.src = logo.data || logo.url || "";
        };

        url.value = logo.url || "";
        url.oninput = (e) => {
          logo.url = e.target.value;
          logo.data = "";
          refresh();
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        file.onchange = async (e) => {
          const f = e.target.files?.[0];
          if (!f) return;

          logo.data = await fileToDataURL(f);
          logo.url = "";
          refresh();
          status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
        };

        pz.addEventListener("paste", async (e) => {
          const items = e.clipboardData?.items || [];
          for (const it of items) {
            if (it.type?.startsWith("image/")) {
              const f = it.getAsFile();
              if (f) {
                logo.data = await fileToDataURL(f);
                logo.url = "";
                refresh();
                status("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸");
                break;
              }
            }
          }
        });

        refresh();
      }

      // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      function updateProgress() {
        let progress = 0;
        const totalSections = 6; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        if (state.meta.title) progress += 10;
        if (state.meta.subject) progress += 5;
        if (state.meta.duration) progress += 5;
        if (state.meta.objectives) progress += 5;

        // Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø©
        if (state.feedback.text) progress += 10;
        if (state.feedback.images.length > 0) progress += 5;

        // Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†
        if (state.exercises.length > 0) {
          progress += 15;
          state.exercises.forEach((ex) => {
            if (ex.prompt && ex.solution) progress += 2;
          });
        }

        // Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        if (state.quiz.length > 0) {
          progress += 15;
          state.quiz.forEach((q) => {
            if (q.text && q.options.length >= 2) progress += 2;
          });
        }

        // Ø§Ù„ØªØ°ÙŠÙŠÙ„ ÙˆØ§Ù„Ø´Ø¹Ø§Ø±
        if (state.footer.text) progress += 5;
        if (state.branding.logo.data || state.branding.logo.url) progress += 5;

        // Ø§Ù„ØªØµÙ…ÙŠÙ…
        if (state.design.primary !== "#22c55e") progress += 5;

        // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªÙ‚Ø¯Ù…
        progress = Math.min(progress, 100);

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        $("#progressFill").style.width = `${progress}%`;
        $("#progressPercent").textContent = `${progress}%`;
      }

      // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
      function renderAll() {
        bindInputs();
        renderFeedbackImages();
        renderExercises();
        renderQuiz();

        document.documentElement.style.setProperty(
          "--primary",
          state.design.primary
        );
        document.body.style.fontFamily = state.design.font;
        document.documentElement.setAttribute(
          "dir",
          state.design.rtl ? "rtl" : "ltr"
        );

        populateProjects();
        updateProgress();
      }

      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      document.addEventListener("DOMContentLoaded", () => {
        renderAll();

        // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù…Ø´Ø±ÙˆØ¹ ØªÙ… ÙØªØ­Ù‡ Ø¥Ù† ÙˆØ¬Ø¯
        const lastProjectId = localStorage.getItem("last_project");
        if (lastProjectId) {
          loadFromLocal(lastProjectId);
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener("beforeunload", (e) => {
          if ($("#status").textContent.includes("ØºÙŠØ± Ù…Ø­ÙÙˆØ¸")) {
            e.preventDefault();
            e.returnValue =
              "ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø¯ÙˆÙ† Ø­ÙØ¸ØŸ";
            return e.returnValue;
          }
        });

        // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
        if (state.id) {
          localStorage.setItem("last_project", state.id);
        }
      });
    </script>
  </body>
</html>
